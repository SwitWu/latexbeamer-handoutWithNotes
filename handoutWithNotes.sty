% Copyright 2009 by Guido Diepen <guido@guidodiepen.nl>
% 	Parts provided by Edson Valle
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
% 
% Changelog
%       20180920 - Refactored to work with different slide sizes
%	20091202 - Added "1 on 1 with notes" layout, provided by Harald Welte
%	20091108 - Added "2 on 1 with notes landscape" layout, provided by Edson Valle
%	20091104 - Added "3 on 1 with notes" layout
%	20091104 - Added "2 on 1 with notes" layout
%	20091104 - Added "1 on 1 with notes landscape" layout, provided by Edson Valle
%   20090101 - Initial Version

\ProvidesPackage{handoutWithNotes}
\RequirePackage{l3keys2e}
\ExplSyntaxOn
\keys_define:nn {handoutWithNotes} {
	slide-frame .bool_gset:N =  \g__ptxcd_print_slide_frame_bool,
	slide-frame .initial:n = false,
	slide-frame .default:n = true,
	note-frame .bool_gset:N =  \g__ptxcd_print_note_frame_bool,
	note-frame .initial:n = false,
	note-frame .default:n = true,
}

\ProcessKeysOptions{handoutWithNotes}

\newcommand*{\handoutwithNotes@conditionalFrame}[1]{
	\bool_if:cT {g__ptxcd_print_#1_frame_bool} {\pgfusepath{stroke}}
}
\ExplSyntaxOff

\RequirePackage{pgfpages}

\expandafter\ifx\csname pageheight\endcsname\relax
	\newcommand*{\handoutwithNotes@pageheight}{\pdfpageheight}
\else
	\newcommand*{\handoutwithNotes@pageheight}{\pageheight}
\fi

\ExplSyntaxOn
\newbox\notesbox
\newcommand{\handoutWithNotes@initNotesBox}[1]{
	\setbox\notesbox=\vbox{
		\hsize=\paperwidth
		\vskip-1in\hskip-1in\vbox{
			\vskip.05\handoutwithNotes@pageheight
			Notes\vskip.1\handoutwithNotes@pageheight
			\hrule width\paperwidth\vskip.1\handoutwithNotes@pageheight
			\hrule width\paperwidth\vskip.1\handoutwithNotes@pageheight
			\hrule width\paperwidth\vskip.1\handoutwithNotes@pageheight
			\hrule width\paperwidth\vskip.1\handoutwithNotes@pageheight
			\hrule width\paperwidth\vskip.1\handoutwithNotes@pageheight
			\hrule width\paperwidth\vskip.1\handoutwithNotes@pageheight
			\hrule width\paperwidth\vskip.1\handoutwithNotes@pageheight
			\hrule width\paperwidth
		}
	}
	\int_step_inline:nnn {#1+1} {2*#1} {\pgfpagesshipoutlogicalpage{##1}\copy\notesbox}
}
\ExplSyntaxOff

% 1 on 1 with notes landscape
%  ----------------------------------------
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
%  ----------------------------------------
\pgfpagesdeclarelayout{1 on 1 with notes landscape} {
	\edef\pgfpageoptionheight{\the\paperwidth}
	\edef\pgfpageoptionwidth{\the\paperheight}
	\edef\pgfpageoptionborder{0pt}
}
{
	\setkeys{pgfpagesuselayoutoption}{landscape}
	\pgfpagesphysicalpageoptions
	{%
		logical pages=2,%
		physical height=\pgfpageoptionheight,%
		physical width=\pgfpageoptionwidth,%
		last logical shipout=1%
	}

	\pgfpageslogicalpageoptions{1}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.5\pgfphysicalheight,%
		center=\pgfpoint{.25\pgfphysicalwidth}{.5\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
	}%

	\pgfpageslogicalpageoptions{2}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.5\pgfphysicalheight,%
		center=\pgfpoint{.75\pgfphysicalwidth}{.5\pgfphysicalheight},%
		copy from=2,%
		border code=\handoutwithNotes@conditionalFrame{note},%
	}%    

    \AtBeginDocument{
			\handoutWithNotes@initNotesBox{1}
		}
}
 

% 4 on 1 with notes
%  --------------------------
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% |                          | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% |                          | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% |                          | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
%  --------------------------
 \pgfpagesdeclarelayout{4 on 1 with notes} {
    \edef\pgfpageoptionheight{\the\paperheight}
    \edef\pgfpageoptionwidth{\the\paperwidth}
    \edef\pgfpageoptionborder{0pt}
 }
 {
    \pgfpagesphysicalpageoptions
    {%
		logical pages=8,%
		physical height=\pgfpageoptionheight,%
		physical width=\pgfpageoptionwidth,%
		last logical shipout=4%
    }
    
    \pgfpageslogicalpageoptions{1}
    {%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.25\pgfphysicalheight,%
		center=\pgfpoint{.25\pgfphysicalwidth}{.875\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
    }%
    \pgfpageslogicalpageoptions{2}
    {%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.25\pgfphysicalheight,%
		center=\pgfpoint{.25\pgfphysicalwidth}{.625\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
    }%

    \pgfpageslogicalpageoptions{3}
    {%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.25\pgfphysicalheight,%
		center=\pgfpoint{.25\pgfphysicalwidth}{.375\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
    }%

    \pgfpageslogicalpageoptions{4}
    {%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.25\pgfphysicalheight,%
		center=\pgfpoint{.25\pgfphysicalwidth}{.125\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
    }%
	
	
	\pgfpageslogicalpageoptions{5}
    {%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.25\pgfphysicalheight,%
		center=\pgfpoint{.75\pgfphysicalwidth}{.875\pgfphysicalheight},%
		copy from=5,%
		border code=\handoutwithNotes@conditionalFrame{note},%
    }%
    \pgfpageslogicalpageoptions{6}
    {%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.25\pgfphysicalheight,%
		center=\pgfpoint{.75\pgfphysicalwidth}{.625\pgfphysicalheight},%
		copy from=6,%
		border code=\handoutwithNotes@conditionalFrame{note},%
    }%
    \pgfpageslogicalpageoptions{7}
    {%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.25\pgfphysicalheight,%
		center=\pgfpoint{.75\pgfphysicalwidth}{.375\pgfphysicalheight},%
		copy from=7,%
		border code=\handoutwithNotes@conditionalFrame{note},%
    }%
    \pgfpageslogicalpageoptions{8}
    {%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.25\pgfphysicalheight,%
		center=\pgfpoint{.75\pgfphysicalwidth}{.125\pgfphysicalheight},%
		copy from=8,%
		border code=\handoutwithNotes@conditionalFrame{note},%
    }%
    
	\AtBeginDocument{
		\handoutWithNotes@initNotesBox{4}
	}
}


% 2 on 1 with notes
%  --------------------------
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% |                          | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
%  --------------------------
\pgfpagesdeclarelayout{2 on 1 with notes} {
	\edef\pgfpageoptionheight{\the\paperheight}
	\edef\pgfpageoptionwidth{\the\paperwidth}
	\edef\pgfpageoptionborder{0pt}
}
{
	\pgfpagesphysicalpageoptions
	{%
		logical pages=4,%
		physical height=\pgfpageoptionheight,%
		physical width=\pgfpageoptionwidth,%
		last logical shipout=2%
	}
	
	\pgfpageslogicalpageoptions{1}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.5\pgfphysicalheight,%
		center=\pgfpoint{.25\pgfphysicalwidth}{.75\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
	}%
	
	\pgfpageslogicalpageoptions{2}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.5\pgfphysicalheight,%
		center=\pgfpoint{.25\pgfphysicalwidth}{.25\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
	}%
	
	\pgfpageslogicalpageoptions{3}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.5\pgfphysicalheight,%
		center=\pgfpoint{.75\pgfphysicalwidth}{.75\pgfphysicalheight},%
		copy from=3,%
		border code=\handoutwithNotes@conditionalFrame{note},%
	}%
	
	\pgfpageslogicalpageoptions{4}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.5\pgfphysicalheight,%
		center=\pgfpoint{.75\pgfphysicalwidth}{.25\pgfphysicalheight},%
		copy from=4,%
		border code=\handoutwithNotes@conditionalFrame{note},%
	}%
	
	\AtBeginDocument{
		\handoutWithNotes@initNotesBox{2}
	}
}


% 3 on 1 with notes
%  --------------------------
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% |                          | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% |                          | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
% | %%%%%%%%%%%  ___________ | 
%  --------------------------
\pgfpagesdeclarelayout{3 on 1 with notes} {
	\edef\pgfpageoptionheight{\the\paperheight}
	\edef\pgfpageoptionwidth{\the\paperwidth}
	\edef\pgfpageoptionborder{0pt}
}
{
	\pgfpagesphysicalpageoptions
	{%
		logical pages=6,%
		physical height=\pgfpageoptionheight,%
		physical width=\pgfpageoptionwidth,%
		last logical shipout=3%
	}
	
	\pgfpageslogicalpageoptions{1}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.33\pgfphysicalheight,%
		center=\pgfpoint{.25\pgfphysicalwidth}{.83\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
	}%
	
	\pgfpageslogicalpageoptions{2}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.33\pgfphysicalheight,%
		center=\pgfpoint{.25\pgfphysicalwidth}{.50\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
	}%
	
	\pgfpageslogicalpageoptions{3}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.33\pgfphysicalheight,%
		center=\pgfpoint{.25\pgfphysicalwidth}{.17\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
	}%	
	
	\pgfpageslogicalpageoptions{4}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.33\pgfphysicalheight,%
		center=\pgfpoint{.75\pgfphysicalwidth}{.83\pgfphysicalheight},%
		copy from=4,%
		border code=\handoutwithNotes@conditionalFrame{note},%
	}%
	
	\pgfpageslogicalpageoptions{5}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.33\pgfphysicalheight,%
		center=\pgfpoint{.75\pgfphysicalwidth}{.50\pgfphysicalheight},%
		copy from=5,%
		border code=\handoutwithNotes@conditionalFrame{note},%
	}%
	
	\pgfpageslogicalpageoptions{6}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.33\pgfphysicalheight,%
		center=\pgfpoint{.75\pgfphysicalwidth}{.17\pgfphysicalheight},%
		copy from=6,%
		border code=\handoutwithNotes@conditionalFrame{note},%
	}%
	
	\AtBeginDocument{
		\handoutWithNotes@initNotesBox{3}
	}
}


% 2 on 1 with notes landscape
%  ----------------------------------------
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% |                                        | 
% |                                        | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
% | %%%%%%%%%%%%%%%%%%  __________________ | 
%  ----------------------------------------
 \pgfpagesdeclarelayout{2 on 1 with notes landscape} {
    \edef\pgfpageoptionheight{\the\paperheight}
    \edef\pgfpageoptionwidth{\the\paperwidth}
    \edef\pgfpageoptionborder{0pt}
 }
 {
    \setkeys{pgfpagesuselayoutoption}{landscape}
    
    \pgfpagesphysicalpageoptions
    {%
		logical pages=4,%
		physical height=\pgfpageoptionheight,%
		physical width=\pgfpageoptionwidth,%
		last logical shipout=2%
    }
   
	\pgfpageslogicalpageoptions{1}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.5\pgfphysicalheight,%
		center=\pgfpoint{.25\pgfphysicalwidth}{.75\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
	}%
	
	\pgfpageslogicalpageoptions{2}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.5\pgfphysicalheight,%
		center=\pgfpoint{.25\pgfphysicalwidth}{.25\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
	}%

	\pgfpageslogicalpageoptions{3}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.5\pgfphysicalheight,%
		center=\pgfpoint{.75\pgfphysicalwidth}{.25\pgfphysicalheight},%
		copy from=3,%
		border code=\handoutwithNotes@conditionalFrame{note},%
	}%   
   
	\pgfpageslogicalpageoptions{4}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=.5\pgfphysicalwidth,%
		resized height=.5\pgfphysicalheight,%
		center=\pgfpoint{.75\pgfphysicalwidth}{.75\pgfphysicalheight},%
		copy from=4,%
		border code=\handoutwithNotes@conditionalFrame{note},%
	}%

	\AtBeginDocument{
		\handoutWithNotes@initNotesBox{2}
	}
}


% 1 on 1 with notes
%  --------------------------
% | %%%%%%%%%%%%%%%%%%%%%%%% | 
% | %%%%%%%%%%%%%%%%%%%%%%%% | 
% | %%%%%%%%%%%%%%%%%%%%%%%% | 
% | %%%%%%%%%%%%%%%%%%%%%%%% | 
% | %%%%%%%%%%%%%%%%%%%%%%%% | 
% | %%%%%%%%%%%%%%%%%%%%%%%% | 
% | %%%%%%%%%%%%%%%%%%%%%%%% | 
% |                          | 
% | ________________________ | 
% | ________________________ | 
% | ________________________ | 
% | ________________________ | 
% | ________________________ | 
% | ________________________ | 
% | ________________________ | 
%  --------------------------
\pgfpagesdeclarelayout{1 on 1 with notes} {
	\edef\pgfpageoptionheight{\the\paperwidth}
	\edef\pgfpageoptionwidth{\the\paperheight}
	\edef\pgfpageoptionborder{0pt}
}
{
	\pgfpagesphysicalpageoptions
	{%
		logical pages=2,%
		physical height=\pgfpageoptionheight,%
		physical width=\pgfpageoptionwidth,%
		last logical shipout=1%
	}
	
	\pgfpageslogicalpageoptions{1}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=\pgfphysicalwidth,%
		resized height=.5\pgfphysicalheight,%
		center=\pgfpoint{.5\pgfphysicalwidth}{.75\pgfphysicalheight},%
		border code=\handoutwithNotes@conditionalFrame{slide},%
	}%
	
	\pgfpageslogicalpageoptions{2}
	{%
		border shrink=\pgfpageoptionborder,%
		resized width=\pgfphysicalwidth,%
		resized height=.5\pgfphysicalheight,%
		center=\pgfpoint{.5\pgfphysicalwidth}{.25\pgfphysicalheight},%
		copy from=2,%
		border code=\handoutwithNotes@conditionalFrame{note},%
	}%    
	
	\AtBeginDocument{
		\handoutWithNotes@initNotesBox{1}
	}
}



